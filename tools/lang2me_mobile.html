<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lang2ME</title>
    <style>
        :root {
            --primary: #27ae60;
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #2c3e50;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; background: var(--bg); color: var(--text);
            display: flex; flex-direction: column; height: 100vh;
        }
        
        header { background: #1a1a1a; color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 10; }
        
        .menu-flutuante { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; 
            background: var(--card); border-bottom: 2px solid #ddd;
        }
        
        button { 
            padding: 12px; border-radius: 10px; border: 1px solid #ccc; 
            background: white; font-weight: bold; font-size: 13px; transition: 0.2s;
        }
        .btn-save { background: var(--primary); color: white; border: none; }
        .btn-save:active { background: #219150; transform: scale(0.95); }

        .search-box { padding: 10px 15px; background: var(--bg); }
        #search { width: 100%; padding: 12px 20px; border: 1.5px solid #ddd; border-radius: 25px; font-size: 16px; outline: none; }

        /* Estilo das Caixas (Cards) */
        #container-cards { flex: 1; overflow-y: auto; padding: 10px; }
        .card { 
            background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee;
        }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: #888; font-weight: bold; }
        .card-header .status { color: var(--primary); display: none; }
        .card.mod .status { display: inline; }
        .card.mod { border-left: 6px solid var(--primary); }

        .card-input { 
            width: 100%; border: 1px solid #eee; border-radius: 8px; padding: 10px;
            font-size: 16px; font-family: 'Consolas', monospace; background: #fdfdfd;
            box-sizing: border-box; min-height: 80px; resize: none;
        }
        .card-input:focus { border-color: var(--primary); background: #fff; outline: none; }

        .original-preview { font-size: 11px; color: #999; margin-top: 8px; font-style: italic; }

    </style>
</head>
<body>

<header>Lang2ME</header>

<div class="menu-flutuante">
    <button onclick="document.getElementById('f').click()">ABRIR ARQUIVO</button>
    <button class="btn-save" onclick="saveFile()">SALVAR BIN</button>
    <button onclick="document.getElementById('j').click()">IMPORTAR JSON</button>
    <button onclick="exportJson()">EXPORTAR JSON</button>
</div>

<div class="search-box">
    <input type="text" id="search" placeholder="Filtrar por texto..." oninput="renderCards()">
</div>

<div id="container-cards">
    <div style="text-align: center; margin-top: 50px; color: #999;">Abra um arquivo binário para começar a edição em caixas.</div>
</div>

<input type="file" id="f" style="display:none" onchange="loadFile(this)">
<input type="file" id="j" style="display:none" accept=".json" onchange="loadJson(this)">

<script>
    let fileStructure = [], allTexts = [], originalTexts = [];

    async function loadFile(input) {
        const file = input.files[0];
        if (!file) return;
        const buf = await file.arrayBuffer();
        const data = new Uint8Array(buf);
        
        fileStructure = []; allTexts = [];
        let cursor = 0;
        while (cursor < data.length) {
            let found = false;
            if (cursor + 2 < data.length) {
                const len = (data[cursor] << 8) | data[cursor + 1];
                const end = cursor + 2 + len;
                if (end <= data.length && len > 0) {
                    const slice = data.slice(cursor + 2, end);
                    const txt = new TextDecoder().decode(slice);
                    if (/^[\x20-\xFF\n\r\t]*$/.test(txt)) {
                        fileStructure.push({t: 'txt', v: txt});
                        allTexts.push(txt);
                        cursor = end; found = true;
                    }
                }
            }
            if (!found) {
                const b = data[cursor];
                if (fileStructure.length > 0 && fileStructure[fileStructure.length - 1].t === 'dat') {
                    let old = fileStructure[fileStructure.length - 1].v;
                    let n = new Uint8Array(old.length + 1);
                    n.set(old); n[old.length] = b;
                    fileStructure[fileStructure.length - 1].v = n;
                } else {
                    fileStructure.push({t: 'dat', v: new Uint8Array([b])});
                }
                cursor++;
            }
        }
        originalTexts = [...allTexts];
        renderCards();
    }

    function renderCards() {
        const container = document.getElementById('container-cards');
        const search = document.getElementById('search').value.toLowerCase();
        container.innerHTML = '';

        allTexts.forEach((txt, i) => {
            if (txt.toLowerCase().includes(search)) {
                const isMod = txt !== originalTexts[i];
                const card = document.createElement('div');
                card.className = 'card' + (isMod ? ' mod' : '');
                card.innerHTML = `
                    <div class="card-header">
                        <span>ENTRADA #${i}</span>
                        <span class="status">✅ MODIFICADO</span>
                    </div>
                    <textarea class="card-input" oninput="updateText(${i}, this)">${txt}</textarea>
                    <div class="original-preview">Original: ${originalTexts[i].substring(0, 40)}...</div>
                `;
                container.appendChild(card);
            }
        });
    }

    function updateText(index, element) {
        allTexts[index] = element.value;
        const card = element.parentElement;
        if (allTexts[index] !== originalTexts[index]) {
            card.classList.add('mod');
        } else {
            card.classList.remove('mod');
        }
    }

    function saveFile() {
        let tIdx = 0;
        const parts = fileStructure.map(p => {
            if (p.t === 'dat') return p.v;
            const b = new TextEncoder().encode(allTexts[tIdx++]);
            const res = new Uint8Array(2 + b.length);
            res[0] = (b.length >> 8) & 0xFF; res[1] = b.length & 0xFF;
            res.set(b, 2);
            return res;
        });
        const blob = new Blob(parts, {type: "application/octet-stream"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "TRADUCAO_MOBILE.bin";
        a.click();
    }

    function exportJson() {
        const blob = new Blob([JSON.stringify(allTexts, null, 2)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "traducao.json";
        a.click();
    }

    async function loadJson(input) {
        const file = input.files[0]; if (!file) return;
        allTexts = JSON.parse(await file.text());
        renderCards();
    }
</script>

</body>
</html>
