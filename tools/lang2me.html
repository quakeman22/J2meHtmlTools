<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lang2ME 1.3 - Web Version</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --accent: #0078d4;
            --border: #ccc;
            --modified-color: #d4edda;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); margin: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* Navbar */
        .navbar { background: #333; color: white; padding: 10px 20px; display: flex; gap: 15px; align-items: center; }
        .navbar button { background: #444; color: white; border: 1px solid #666; padding: 5px 12px; cursor: pointer; border-radius: 4px; }
        .navbar button:hover { background: #555; }

        /* Toolbar */
        .toolbar { padding: 10px 20px; background: #eee; border-bottom: 1px solid var(--border); display: flex; gap: 20px; align-items: center; }
        .toolbar input, .toolbar select { padding: 5px; border-radius: 4px; border: 1px solid var(--border); }

        /* Main Layout */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        #list-container { width: 350px; border-right: 1px solid var(--border); background: var(--panel-bg); display: flex; flex-direction: column; }
        #entry-list { list-style: none; margin: 0; padding: 0; overflow-y: auto; flex: 1; }
        #entry-list li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em; }
        #entry-list li:hover { background: #f0f0f0; }
        #entry-list li.selected { background: var(--accent) !important; color: white; }
        #entry-list li.modified { background: var(--modified-color); }

        #editor-container { flex: 1; display: flex; flex-direction: column; padding: 20px; background: var(--panel-bg); }
        #text-editor { flex: 1; width: 100%; font-family: 'Consolas', monospace; font-size: 16px; padding: 15px; border: 1px solid var(--border); resize: none; box-sizing: border-box; }
        
        .footer-info { display: flex; justify-content: space-between; padding: 10px 0; color: #666; font-size: 0.85em; }
        
        hidden-input { display: none; }
    </style>
</head>
<body>

<div class="navbar">
    <strong>Lang2ME 1.3</strong>
    <button onclick="document.getElementById('fileInput').click()">Abrir Bin√°rio</button>
    <button onclick="saveBinary()">Salvar Bin√°rio</button>
    <button onclick="document.getElementById('jsonInput').click()">Importar JSON</button>
    <button onclick="exportJSON()">Exportar JSON</button>
    <input type="file" id="fileInput" style="display:none" onchange="autoScanFile(this)">
    <input type="file" id="jsonInput" style="display:none" accept=".json" onchange="importJSON(this)">
</div>

<div class="toolbar">
    <div>
        <label>üîç Localizar:</label>
        <input type="text" id="searchInput" placeholder="Filtrar textos..." oninput="refreshList()">
    </div>
    <div>
        <label>Byte Order:</label>
        <select id="endianCombo" onchange="alert('Ordem alterada. Re-abra o arquivo para processar corretamente.')">
            <option value="BE">Big Endian (00 04)</option>
            <option value="LE">Little Endian (04 00)</option>
        </select>
    </div>
    <div>
        <label>Encoding:</label>
        <select id="encodingCombo">
            <option value="utf-8">UTF-8</option>
            <option value="iso-8859-1">ISO-8859-1</option>
        </select>
    </div>
</div>

<div class="main-container">
    <div id="list-container">
        <ul id="entry-list"></ul>
    </div>
    <div id="editor-container">
        <div id="status-label">Aguardando arquivo...</div>
        <textarea id="text-editor" oninput="updateInMemory()"></textarea>
        <div class="footer-info">
            <span id="size-label">Tamanho: 0 bytes</span>
            <span id="modified-label">Modificado: N√£o</span>
        </div>
    </div>
</div>

<script>
    let fileStructure = []; // Estrutura: {type: 'data'|'text', value: Uint8Array|String}
    let allTexts = [];
    let originalTexts = [];
    let selectedIndex = -1;

    // --- L√≥gica de Escaneamento ---
    async function autoScanFile(input) {
        if (!input.files[0]) return;
        const buffer = await input.files[0].arrayBuffer();
        const data = new Uint8Array(buffer);
        const endian = document.getElementById('endianCombo').value;
        const encoding = document.getElementById('encodingCombo').value;

        fileStructure = [];
        allTexts = [];
        let cursor = 0;

        while (cursor < data.length) {
            let found = false;

            if (cursor + 2 <= data.length) {
                // L√™ o tamanho (Uint16) baseado no Endianness
                const view = new DataView(data.buffer, cursor, 2);
                const length = (endian === "BE") ? view.getUint16(0, false) : view.getUint16(0, true);
                
                const start = cursor + 2;
                const end = start + length;

                if (end <= data.length && length > 0) {
                    const potentialBytes = data.slice(start, end);
                    const text = new TextDecoder(encoding).decode(potentialBytes);
                    
                    if (isPrintable(text)) {
                        fileStructure.push({ type: 'text', value: text });
                        allTexts.push(text);
                        cursor = end;
                        found = true;
                    }
                }
            }

            if (!found) {
                const byte = data[cursor];
                if (fileStructure.length > 0 && fileStructure[fileStructure.length - 1].type === 'data') {
                    // Mescla bytes consecutivos para performance
                    let last = fileStructure[fileStructure.length - 1].value;
                    let newArr = new Uint8Array(last.length + 1);
                    newArr.set(last);
                    newArr[last.length] = byte;
                    fileStructure[fileStructure.length - 1].value = newArr;
                } else {
                    fileStructure.push({ type: 'data', value: new Uint8Array([byte]) });
                }
                cursor++;
            }
        }

        originalTexts = [...allTexts];
        document.getElementById('status-label').innerText = `Entradas: ${allTexts.length}`;
        refreshList();
    }

    function isPrintable(str) {
        // L√≥gica similar ao Python: verifica se n√£o √© lixo bin√°rio
        return /^[\x20-\xFF\n\r\t]*$/.test(str);
    }

    // --- UI e Lista ---
    function refreshList() {
        const list = document.getElementById('entry-list');
        const filter = document.getElementById('searchInput').value.toLowerCase();
        list.innerHTML = "";

        let textIdx = 0;
        fileStructure.forEach((item) => {
            if (item.type === 'text') {
                const currentIdx = textIdx;
                const textValue = allTexts[currentIdx];

                if (textValue.toLowerCase().includes(filter)) {
                    const li = document.createElement('li');
                    li.textContent = `[${currentIdx.toString().padStart(3, '0')}] ${textValue.substring(0, 50).replace(/\n/g, ' ')}`;
                    
                    if (textValue !== originalTexts[currentIdx]) li.classList.add('modified');
                    if (currentIdx === selectedIndex) li.classList.add('selected');

                    li.onclick = () => loadText(currentIdx);
                    list.appendChild(li);
                }
                textIdx++;
            }
        });
    }

    function loadText(idx) {
        selectedIndex = idx;
        const editor = document.getElementById('text-editor');
        editor.value = allTexts[idx];
        
        document.querySelectorAll('#entry-list li').forEach(el => el.classList.remove('selected'));
        // Re-selecionar visualmente na lista filtrada se necess√°rio
        refreshList();
        updateByteInfo();
    }

    function updateInMemory() {
        if (selectedIndex === -1) return;
        allTexts[selectedIndex] = document.getElementById('text-editor').value;
        updateByteInfo();
        document.getElementById('modified-label').innerText = "Modificado: Sim";
    }

    function updateByteInfo() {
        const encoding = document.getElementById('encodingCombo').value;
        const bytes = new TextEncoder().encode(allTexts[selectedIndex]);
        document.getElementById('size-label').innerText = `Tamanho: ${bytes.length} bytes`;
    }

    // --- Exporta√ß√£o ---
    async function saveBinary() {
        if (fileStructure.length === 0) return;

        const endian = document.getElementById('endianCombo').value;
        const encoding = document.getElementById('encodingCombo').value;
        const chunks = [];
        let textCounter = 0;

        fileStructure.forEach(item => {
            if (item.type === 'data') {
                chunks.push(item.value);
            } else {
                const textBytes = new TextEncoder(encoding).encode(allTexts[textCounter]);
                const header = new ArrayBuffer(2);
                const view = new DataView(header);
                
                // Grava o tamanho no endian correto
                if (endian === "BE") view.setUint16(0, textBytes.length, false);
                else view.setUint16(0, textBytes.length, true);
                
                chunks.push(new Uint8Array(header));
                chunks.push(textBytes);
                textCounter++;
            }
        });

        const blob = new Blob(chunks, { type: "application/octet-stream" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "MODIFIED.bin";
        link.click();
    }

    function exportJSON() {
        const blob = new Blob([JSON.stringify(allTexts, null, 4)], { type: "application/json" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "export.json";
        link.click();
    }

    function importJSON(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            allTexts = JSON.parse(e.target.result);
            refreshList();
            alert("JSON importado com sucesso!");
        };
        reader.readAsText(input.files[0]);
    }
</script>

</body>
</html>
