<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Class Editor Web + JSON</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { color: #666; font-size: 0.9em; margin-bottom: 20px; padding: 10px; background: #eee; border-radius: 4px; border-left: 4px solid #007bff; }
        .block-item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; flex-direction: column; }
        .info { font-size: 11px; color: #888; margin-bottom: 5px; }
        .input-group { display: flex; gap: 10px; align-items: center; }
        .index-label { font-weight: bold; color: #555; min-width: 30px; }
        input[type="text"] { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .actions { margin-bottom: 20px; display: flex; gap: 8px; flex-wrap: wrap; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; background: #007bff; color: white; font-weight: bold; }
        button:hover { opacity: 0.9; }
        .btn-json { background: #6f42c1; } /* Roxo para JSON */
        .btn-save { background: #28a745; }
        .btn-clear { background: #6c757d; }
    </style>
</head>
<body>

<div class="container">
    <h2>Class Editor Pro</h2>
    
    <div class="actions">
        <input type="file" id="fileInput" style="display: none;" accept=".class">
        <input type="file" id="jsonInput" style="display: none;" accept=".json">
        
        <button onclick="document.getElementById('fileInput').click()">üìÇ Abrir .CLASS</button>
        <button class="btn-json" id="btnExportJson">üì§ Exportar JSON</button>
        <button class="btn-json" onclick="document.getElementById('jsonInput').click()">üì• Importar JSON</button>
        <button class="btn-save" id="btnSave">üíæ Salvar .CLASS</button>
        <button class="btn-clear" id="btnClear">üßπ Limpar</button>
    </div>

    <div id="tvStatus" class="status">Aguardando arquivo Java Class...</div>
    
    <div id="containerBlocks"></div>
</div>

<script>
let fileContentCache = null;
let editorBlocks = [];
let originalFileName = "arquivo.class";

const tvStatus = document.getElementById('tvStatus');
const containerBlocks = document.getElementById('containerBlocks');
const fileInput = document.getElementById('fileInput');
const jsonInput = document.getElementById('jsonInput');

// --- LEITURA DO ARQUIVO .CLASS ---
fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    originalFileName = file.name;
    const reader = new FileReader();
    updateStatus("Lendo estrutura bin√°ria...");
    
    reader.onload = function(event) {
        fileContentCache = new Uint8Array(event.target.result);
        if (parseClassFile()) {
            renderEditableBlocks();
            updateStatus(`Arquivo "${file.name}" carregado. ${editorBlocks.length} strings encontradas.`);
        } else {
            updateStatus("Erro: O arquivo n√£o possui strings edit√°veis ou n√£o √© um .class v√°lido.");
        }
    };
    reader.readAsArrayBuffer(file);
});

// --- EXPORTAR PARA JSON ---
document.getElementById('btnExportJson').onclick = function() {
    if (editorBlocks.length === 0) {
        alert("Abra um arquivo .class primeiro!");
        return;
    }

    // Criar objeto no estilo [ index: "texto" ]
    const jsonObject = {};
    editorBlocks.forEach((block, index) => {
        jsonObject[index] = block.currentText;
    });

    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jsonObject, null, 4));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", originalFileName.replace(".class", "") + ".json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
};

// --- IMPORTAR DE JSON ---
jsonInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file || editorBlocks.length === 0) {
        alert("Carregue o arquivo .class antes de importar o JSON!");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const importedData = JSON.parse(event.target.result);
            let count = 0;

            // Mapear as chaves do JSON para os blocos carregados
            Object.keys(importedData).forEach(key => {
                const index = parseInt(key);
                if (editorBlocks[index]) {
                    editorBlocks[index].currentText = importedData[key];
                    count++;
                }
            });

            renderEditableBlocks();
            updateStatus(`JSON importado! ${count} textos atualizados.`);
        } catch (err) {
            alert("Erro ao ler JSON: " + err.message);
        }
    };
    reader.readAsText(file);
});

// --- L√ìGICA DE PARSING BIN√ÅRIO ---
function parseClassFile() {
    editorBlocks = [];
    try {
        const view = new DataView(fileContentCache.buffer);
        let offset = 8; // Skip Magic e Version
        const cpCount = view.getUint16(offset);
        offset += 2;

        let utf8Map = new Map();
        let stringRefs = [];

        for (let i = 1; i < cpCount; i++) {
            const tag = view.getUint8(offset++);
            if (tag === 1) { // Utf8
                const len = view.getUint16(offset);
                offset += 2;
                const bytes = fileContentCache.slice(offset, offset + len);
                const text = new TextDecoder().decode(bytes);
                utf8Map.set(i, { text, offset, len });
                offset += len;
            } else if (tag === 7 || tag === 8) { // Class ou String
                const idx = view.getUint16(offset);
                if (tag === 8) stringRefs.push(idx);
                offset += 2;
            } else if (tag === 3 || tag === 4 || tag === 9 || tag === 10 || tag === 11 || tag === 12) {
                offset += 4;
            } else if (tag === 5 || tag === 6) {
                offset += 8; i++;
            }
        }

        stringRefs.forEach(idx => {
            if (utf8Map.has(idx)) {
                const item = utf8Map.get(idx);
                editorBlocks.push({
                    originalText: item.text,
                    currentText: item.text,
                    offset: item.offset,
                    originalLength: item.len
                });
            }
        });
        return editorBlocks.length > 0;
    } catch (e) { return false; }
}

function renderEditableBlocks() {
    containerBlocks.innerHTML = '';
    editorBlocks.forEach((block, i) => {
        const div = document.createElement('div');
        div.className = 'block-item';
        div.innerHTML = `
            <div class="info">Offset: ${block.offset} | Original: ${block.originalLength} bytes</div>
            <div class="input-group">
                <span class="index-label">${i}:</span>
                <input type="text" value="${escapeHtml(block.currentText)}" oninput="updateBlock(${i}, this.value)">
            </div>
        `;
        containerBlocks.appendChild(div);
    });
}

function updateBlock(index, val) {
    editorBlocks[index].currentText = val;
}

document.getElementById('btnSave').onclick = function() {
    if (!fileContentCache) return;
    // ... (L√≥gica de salvamento bin√°rio id√™ntica √† anterior)
    saveBinary();
};

function saveBinary() {
    let delta = 0;
    editorBlocks.forEach(b => delta += (new TextEncoder().encode(b.currentText).length - b.originalLength));
    
    const newFile = new Uint8Array(fileContentCache.length + delta);
    const view = new DataView(newFile.buffer);
    let lastRead = 0, lastWrite = 0;

    editorBlocks.forEach(block => {
        const header = block.offset - 2;
        newFile.set(fileContentCache.slice(lastRead, header), lastWrite);
        lastWrite += (header - lastRead);

        const bytes = new TextEncoder().encode(block.currentText);
        view.setUint16(lastWrite, bytes.length, false);
        lastWrite += 2;
        newFile.set(bytes, lastWrite);
        lastWrite += bytes.length;
        lastRead = block.offset + block.originalLength;
    });

    newFile.set(fileContentCache.slice(lastRead), lastWrite);
    const blob = new Blob([newFile], {type: "application/octet-stream"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "modded_" + originalFileName;
    a.click();
}

function updateStatus(m) { tvStatus.innerText = m; }
function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
document.getElementById('btnClear').onclick = () => location.reload();
</script>
</body>
</html>
